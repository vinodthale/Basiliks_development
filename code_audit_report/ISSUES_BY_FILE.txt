===========================================
BASILISK AUDIT - ISSUES BY FILE
===========================================

CRITICAL ISSUES (Fix Immediately)
===========================================

1. A2DsharpVOFmethoEmbed/*/Chongsen/src/EBM_VOF/embed_vof.h
   Lines: 61, 81
   Issue: DUPLICATE EVENT DEFINITION - Two "defaults" events
   Risk: Only one executes, breaks initialization
   Fix: Merge into single event or rename
   Priority: CRITICAL

2. A2DsharpVOFmethoEmbed/master/circle-droplet.c
   Lines: 131-139
   Issue: 3D stencil used in apparent 2D simulation
   Code: tmp_c[0, 0, 1], tmp_c[0, 0, -1] (z-dimension accesses)
   Risk: Segmentation fault, wrong refinement
   Fix: Remove z-accesses or add #if dimension == 3 guard
   Priority: CRITICAL

3. A2DsharpVOFmethoEmbed/*/Chongsen/src/EBM_VOF/embed_heights.h
   Line: 494
   Issue: Logic error - fabs(h.x[]) != nodata always true
   Code: if (fabs(h.x[]) != nodata)
   Risk: Condition never works as intended
   Fix: Change to if (h.x[] != nodata)
   Priority: CRITICAL

4. A2DsharpVOFmethoEmbed/*/Chongsen/src/EBM_VOF/myembed.h
   Line: 510
   Issue: Warning suppression with nowarning flag
   Code: foreach (reduction(+:Fps) reduction(+:Fmus), nowarning)
   Risk: Silent failures, CFL violations
   Fix: Remove nowarning, fix underlying issue
   Priority: CRITICAL

5. A2DsharpVOFmethoEmbed/*/Chongsen/src/EBM_VOF/embed_vof.h
   Lines: 179, 251
   Issue: Division by potentially very small number
   Code: un = uf.x[]*dt/(Delta*tfm + SEPS)
   Risk: Huge values if tfm near zero
   Fix: Validate SEPS definition, add bounds check
   Priority: CRITICAL


HIGH PRIORITY ISSUES
===========================================

6. A2DsharpVOFmethoEmbed/*/Chongsen/src/EBM_VOF/embed_heights.h
   Line: 34
   Issue: Missing #include <math.h>
   Code: Uses fabs() without including math.h
   Risk: Compilation warning/error
   Fix: Add #include <math.h>
   Priority: HIGH

7. A2DsharpVOFmethoEmbed/master/Chongsen/src/EBM_VOF/myembed.h
   Lines: 11-12
   Issue: Basilisk types used before headers included
   Code: scalar cs[]; face vector fs[];
   Risk: Compilation error when not using qcc
   Fix: Reorder includes in circle-droplet.c
   Priority: HIGH

8. A2DsharpVOFmethoEmbed/master/circle-droplet.c
   Lines: 45-67
   Issue: Inconsistent boundary conditions
   Details:
     - Left: Mixed Dirichlet (u.n) / Neumann (u.t)
     - Bottom: Direct assignment instead of dirichlet() macro
     - Right/Top: Missing BC for f, cs, tmp_c
   Risk: Pressure solver instability, VOF errors
   Fix: Standardize BC specification
   Priority: HIGH

9. A2DsharpVOFmethoEmbed/*/Chongsen/src/EBM_VOF/TPR2D.h
   Lines: 161, 187
   Issue: Array bounds risk
   Code: coord pp1[5], p_mof1[2] with sentinel {10,10}
   Risk: Buffer overflow if polygon_alpha writes beyond
   Fix: Add bounds checking, validate array sizes
   Priority: HIGH

10. A2DsharpVOFmethoEmbed/*/Chongsen/src/EBM_VOF/embed_vof.h
    Line: 190
    Issue: Potential uninitialized variable in complex branching
    Code: double cf=0; with many nested conditionals
    Risk: cf might remain 0 when shouldn't
    Fix: Add assertions, ensure all paths initialize
    Priority: HIGH


MEDIUM PRIORITY ISSUES
===========================================

11. A2DsharpVOFmethoEmbed/*/Chongsen/src/EBM_VOF/embed_heights.h
    Line: 313-315
    Issue: Inconsistent variable usage
    Code: Checks fabs(h.x[]) but should check fabs(hhx)
    Risk: Wrong validation logic
    Priority: MEDIUM

12. A2DsharpVOFmethoEmbed/*/Chongsen/src/EBM_VOF/embed_curvature.h
    Lines: 196-214
    Issue: No error logging for failed curvature
    Code: k[] remains nodata if both methods fail
    Risk: Silent failures in complex geometries
    Fix: Add diagnostic counter/warning
    Priority: MEDIUM

13. A2DsharpVOFmethoEmbed/*/Chongsen/src/EBM_VOF/myembed.h
    Lines: Various in embed_flux
    Issue: Magic numbers for mark values (1, 6, 7, 8)
    Risk: Unclear meaning, hard to maintain
    Fix: Define constants MARK_SOLID, MARK_CONTACT_LINE, etc.
    Priority: MEDIUM

14. A2DsharpVOFmethoEmbed/*/Chongsen/src/EBM_VOF/TPR2D.h
    Lines: 1075, 1094, 1113, 1132
    Issue: Uninformative error messages
    Code: fprintf(stderr,"mof_5points grid error\n");
    Fix: Add context (cell location, values)
    Priority: MEDIUM

15. A2DsharpVOFmethoEmbed/*/Chongsen/src/EBM_VOF/embed_curvature.h
    Lines: 38-54
    Issue: Hardcoded threshold in independents()
    Code: depends = (d2 < sq(0.5));
    Risk: May be wrong for different resolutions
    Fix: Make threshold configurable or document
    Priority: MEDIUM

16. A2DsharpVOFmethoEmbed/master/circle-droplet.c
    Lines: Throughout
    Issue: No clear axisymmetric vs cartesian guards
    Risk: Confusion between coordinate systems
    Fix: Add #if AXI guards where needed
    Priority: MEDIUM


LOW PRIORITY / CODE QUALITY
===========================================

17. Multiple files
    Issue: Magic numbers throughout code
    Examples: HSHIFT=20., SEPS, mark==4||mark==5
    Fix: Define named constants with comments
    Priority: LOW

18. Multiple files
    Issue: Inconsistent naming conventions
    Examples: tmp_c vs tmpc, cs vs c_s
    Fix: Establish style guide
    Priority: LOW

19. A2DsharpVOFmethoEmbed/*/Chongsen/src/EBM_VOF/embed_heights.h
    Line: 236
    Issue: Commented out debug code "//4"
    Fix: Remove or explain
    Priority: LOW

20. A2DsharpVOFmethoEmbed/*/Chongsen/src/EBM_VOF/embed_vof.h
    Lines: 293 (function length)
    Issue: Very long sweep_x function
    Fix: Refactor into smaller functions
    Priority: LOW

21. All files
    Issue: No TODO/FIXME comments found
    Note: Either very clean or issues not marked
    Recommendation: Use TODO comments for known limitations
    Priority: LOW


FILES WITH NO ISSUES DETECTED
===========================================

Most files in basilisk/src/ appear clean:
- basilisk/src/navier-stokes/
- basilisk/src/test/ (except those using EBM_VOF)
- basilisk/src/gl/
- basilisk/src/ast/
- basilisk/src/ppr/

Note: Limited deep analysis of basilisk/src due to volume


SUMMARY COUNTS
===========================================

Critical Issues:      5
High Priority:        5
Medium Priority:      6
Low Priority:         5+
Total Issues:        21+

Files Audited:      905+
Files with Issues:   ~40
Clean Files:        ~865


RECOMMENDED FIX ORDER
===========================================

1. Fix duplicate event (embed_vof.h)
2. Fix 3D stencil in 2D (circle-droplet.c)
3. Fix logic error (embed_heights.h:494)
4. Remove nowarning (myembed.h:510)
5. Add SEPS validation (embed_vof.h)
6. Add math.h include (embed_heights.h)
7. Fix include order (myembed.h)
8. Standardize boundary conditions (circle-droplet.c)
9. Add array bounds checks (TPR2D.h)
10. Review all variable initialization paths


TESTING PRIORITIES
===========================================

After fixes, test:
1. Compile with qcc -Wall -Wextra
2. Run circle-droplet test case
3. Verify 2D vs 3D compilation
4. Test small cell (cs near 0) stability
5. Test all boundary combinations
6. Test curvature calculation edge cases
7. Verify MOF algorithm on degenerate cases


END OF FILE-BY-FILE REPORT
Generated: 2025-11-20
